# GitLab CI/CD Pipeline for WebStore Project

stages:
  - quality_check
  - build_compile
  - build_scan_image
  - deploy_prod
  - deploy_cloud_run  # NEW STAGE

variables:
  JAVA_VERSION: "21"
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  POSTGRES_DB: "web_store"
  POSTGRES_USER: "postgres"
  POSTGRES_PASSWORD: "postgres"
  POSTGRES_HOST_AUTH_METHOD: "trust"
  GIT_DEPTH: "0"
  DOCKER_IMAGE_NAME: "webstore"
  DOCKER_IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"
  # Cloud Run Configuration
  GCP_PROJECT_ID: "todo-app-477207"
  GCP_REGION: "us-central1"
  ARTIFACT_REGISTRY_REPO: "webstore-repo"
  CLOUD_RUN_SERVICE_NAME: "webstore-service"
  CLOUD_SQL_INSTANCE_CONNECTION: "todo-app-477207:us-central1:web-store-instance"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .gradle/wrapper
    - .gradle/caches

# ============================================
# QUALITY CHECK STAGE
# ============================================

checkstyle:
  stage: quality_check
  image: gradle:8.5-jdk21
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apt-get update -qq && apt-get install -y -qq git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - gradle checkstyleMain checkstyleTest --no-daemon || true
  allow_failure: true

pmd:
  stage: quality_check
  image: gradle:8.5-jdk21
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apt-get update -qq && apt-get install -y -qq git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - gradle pmdMain pmdTest --no-daemon || true
  allow_failure: true

unit_test:
  stage: quality_check
  image: gradle:8.5-jdk21
  services:
    - name: postgres:15
      alias: postgres
  variables:
    DB_URL: "jdbc:postgresql://postgres:5432/${POSTGRES_DB}"
    DB_USERNAME: "${POSTGRES_USER}"
    DB_PASSWORD: "${POSTGRES_PASSWORD}"
    JPA_DDL_AUTO: "validate"
    FLYWAY_ENABLED: "true"
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apt-get update -qq && apt-get install -y -qq postgresql-client git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
    - echo "=== Fixing build.gradle PMD configuration ==="
    - |
      if grep -q 'maxHeapSize = "4g"' build.gradle; then
        sed -i 's/maxHeapSize = "4g"/\/\/ maxHeapSize = "4g"  # Commented out for CI compatibility/' build.gradle
        echo "Fixed build.gradle PMD configuration"
      fi
    - echo "Waiting for PostgreSQL to be ready..."
    - for i in {1..30}; do if pg_isready -h postgres -p 5432 -U postgres > /dev/null 2>&1; then echo "PostgreSQL is ready!"; break; fi; echo "Waiting for postgres... ($i/30)"; sleep 2; done
    - echo "Database connection details:"
    - echo "DB_URL:" ${DB_URL}
    - echo "DB_USERNAME:" ${DB_USERNAME}
  script:
    - gradle test --no-daemon -x pmdMain -x pmdTest
  allow_failure: false

# ============================================
# BUILD COMPILE STAGE
# ============================================

build:
  stage: build_compile
  image: gradle:8.5-jdk21
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apt-get update -qq && apt-get install -y -qq git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - gradle clean build -x test --no-daemon
  artifacts:
    paths:
      - build/libs/*.jar
  only:
    - main
    - develop
    - merge_requests

# ============================================
# BUILD & SCAN DOCKER IMAGE STAGE
# ============================================

build_docker_image:
  stage: build_scan_image
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-docker}
    - apk add --no-cache git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-docker} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - docker build -t ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} .
    - docker build -t ${DOCKER_IMAGE_NAME}:latest .
  only:
    - main
    - develop
    - merge_requests

scan_docker_image:
  stage: build_scan_image
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} || true
  allow_failure: true

# ============================================
# PRODUCTION DOCKER BUILD STAGE
# ============================================

build_prod_docker_image:
  stage: deploy_prod
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apk add --no-cache git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - |
      docker build \
        --build-arg SPRING_PROFILE=prod \
        --build-arg DB_URL="${PROD_DB_URL}" \
        --build-arg DB_USERNAME="${PROD_DB_USERNAME}" \
        --build-arg DB_PASSWORD="${PROD_DB_PASSWORD}" \
        --build-arg JWT_SECRET="${PROD_JWT_SECRET}" \
        --build-arg GOOGLE_CLIENT_ID="${PROD_GOOGLE_CLIENT_ID:-}" \
        -t ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} .
    - docker tag ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:prod-latest
  only:
    - main
  when: manual

# Push to Container Registry
push_prod_docker_image:
  stage: deploy_prod
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "=== Pushing Production Docker Image to Registry ==="
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apk add --no-cache git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
    - docker login -u ${CI_REGISTRY_USER} -p ${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
  script:
    - |
      # Check if image exists, if not build it
      if docker images --format "{{.Repository}}:{{.Tag}}" | grep -q "^${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG}$"; then
        echo "Image ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} already exists, skipping build"
      else
        echo "Image not found, building it now with database connection..."
        docker build \
          --build-arg SPRING_PROFILE=prod \
          --build-arg DB_URL="${PROD_DB_URL}" \
          --build-arg DB_USERNAME="${PROD_DB_USERNAME}" \
          --build-arg DB_PASSWORD="${PROD_DB_PASSWORD}" \
          --build-arg JWT_SECRET="${PROD_JWT_SECRET}" \
          --build-arg GOOGLE_CLIENT_ID="${PROD_GOOGLE_CLIENT_ID:-}" \
          -t ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} .
        docker tag ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} ${DOCKER_IMAGE_NAME}:prod-latest
      fi
    - echo "Tagging and pushing images..."
    - docker tag ${DOCKER_IMAGE_NAME}:prod-${DOCKER_IMAGE_TAG} ${CI_REGISTRY_IMAGE}:prod-${DOCKER_IMAGE_TAG}
    - docker tag ${DOCKER_IMAGE_NAME}:prod-latest ${CI_REGISTRY_IMAGE}:prod-latest
    - docker push ${CI_REGISTRY_IMAGE}:prod-${DOCKER_IMAGE_TAG}
    - docker push ${CI_REGISTRY_IMAGE}:prod-latest
    - echo "Production Docker image pushed successfully!"
    - echo "Image location: ${CI_REGISTRY_IMAGE}:prod-latest"
  dependencies: []
  only:
    - main
  when: manual

# ============================================
# CLOUD RUN DEPLOYMENT STAGE
# ============================================

# Push Docker image to Google Artifact Registry
push_to_artifact_registry:
  stage: deploy_cloud_run
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  before_script:
    - echo "=== Installing gcloud SDK ==="
    - apk add --no-cache curl bash python3 py3-pip
    - curl https://sdk.cloud.google.com | bash
    - export PATH=$PATH:/root/google-cloud-sdk/bin
    - echo "=== Setting up GCP authentication ==="
    - echo "${GCP_SERVICE_ACCOUNT_KEY}" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project ${GCP_PROJECT_ID}
    - echo "=== Configuring Docker for Artifact Registry ==="
    - gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev --quiet
    - echo "=== Verifying Docker connection ==="
    - docker info
    - echo "=== Cloning from GitHub ==="
    - echo "GitHub Repo:" ${GITHUB_REPO_URL}
    - echo "Branch:" ${GITHUB_BRANCH:-main}
    - apk add --no-cache git
    - rm -rf .git
    - git clone --depth 1 --branch ${GITHUB_BRANCH:-main} ${GITHUB_REPO_URL} temp_repo
    - sh -c "mv temp_repo/* temp_repo/.* . 2>/dev/null || true"
    - rm -rf temp_repo
    - echo "=== Repository cloned ==="
  script:
    - echo "=== Building Docker image for Cloud Run ==="
    - |
      docker build \
        --build-arg SPRING_PROFILE=prod \
        --build-arg DB_URL="jdbc:postgresql:///web-store?cloudSqlInstance=${CLOUD_SQL_INSTANCE_CONNECTION}&socketFactory=com.google.cloud.sql.postgres.SocketFactory" \
        --build-arg DB_USERNAME="${PROD_DB_USERNAME}" \
        --build-arg DB_PASSWORD="${PROD_DB_PASSWORD}" \
        --build-arg JWT_SECRET="${PROD_JWT_SECRET}" \
        --build-arg GOOGLE_CLIENT_ID="${PROD_GOOGLE_CLIENT_ID:-}" \
        -t ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
        -t ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:latest \
        .
    - echo "=== Pushing to Artifact Registry ==="
    - docker push ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
    - docker push ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:latest
    - echo "=== Image pushed successfully ==="
    - echo "Image: ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:latest"
  only:
    - main
  when: manual

# Deploy to Cloud Run
deploy_to_cloud_run:
  stage: deploy_cloud_run
  image: google/cloud-sdk:latest
  before_script:
    - echo "=== Setting up GCP authentication ==="
    - echo "${GCP_SERVICE_ACCOUNT_KEY}" | base64 -d > /tmp/gcp-key.json
    - gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
    - gcloud config set project ${GCP_PROJECT_ID}
  script:
    - echo "=== Deploying to Cloud Run ==="
    - |
      gcloud run deploy ${CLOUD_RUN_SERVICE_NAME} \
        --image ${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${ARTIFACT_REGISTRY_REPO}/${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
        --region ${GCP_REGION} \
        --platform managed \
        --allow-unauthenticated \
        --add-cloudsql-instances ${CLOUD_SQL_INSTANCE_CONNECTION} \
        --set-env-vars "SPRING_PROFILES_ACTIVE=prod" \
        --set-env-vars "DB_URL=jdbc:postgresql:///web-store?cloudSqlInstance=${CLOUD_SQL_INSTANCE_CONNECTION}&socketFactory=com.google.cloud.sql.postgres.SocketFactory" \
        --set-env-vars "DB_USERNAME=${PROD_DB_USERNAME}" \
        --set-env-vars "DB_PASSWORD=${PROD_DB_PASSWORD}" \
        --set-env-vars "JWT_SECRET=${PROD_JWT_SECRET}" \
        --set-env-vars "GOOGLE_CLIENT_ID=${PROD_GOOGLE_CLIENT_ID:-}" \
        --set-env-vars "JPA_DDL_AUTO=validate" \
        --set-env-vars "FLYWAY_ENABLED=true" \
        --memory 512Mi \
        --cpu 1 \
        --min-instances 0 \
        --max-instances 10 \
        --timeout 300 \
        --port 8080
    - echo "=== Deployment completed ==="
    - echo "Getting service URL..."
    - gcloud run services describe ${CLOUD_RUN_SERVICE_NAME} --region ${GCP_REGION} --format 'value(status.url)'
  dependencies: []
  only:
    - main
  when: manual